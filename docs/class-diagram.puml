@startuml
left to right direction
skinparam classAttributeIconSize 0

class User {
  - String name
  - int points
  - boolean admin
  - boolean moderator
}

class Message {
  - User sender
  - String content
  - String timestamp
}

abstract class Chat {
  - String name
  - List<Message> messages
  - User admin
  - MiniGame activeGame
  + sendMessage(User, String)
  + launchGame(User, String)
  + processGameInput(User, String)
  + getActiveGame()
}
class PublicChat
class PrivateChat {
  - Map<User, Integer> users
  + setPoints(User, int)
  + users() : Map<User, Integer>
}
Chat <|-- PublicChat
Chat <|-- PrivateChat
Chat o-- Message
Chat o-- MiniGame
PrivateChat o-- User

interface MiniGame {
  + getCommandName()
  + start()
  + processInput(User, String)
  + isFinished()
  + getResults()
  + reset()
}
class QuizGame {
  - Map<User, Integer> scores
  - List<QuizQuestion> questions
  - int currentQuestionIndex
  - boolean isActive
}
MiniGame <|.. QuizGame
QuizGame o-- User

class Choice {
  - String text
  - Collection<User> voters
  + newVoter(User)
  + voters() : Collection<User>
}

' ========== NEW BETTING SYSTEM ==========
enum BetType {
  DISCRETE_CHOICE
  NUMERIC_VALUE
  ORDERED_RANKING
}

abstract class Bet {
  # String question
  # User creator
  # WatchParty watchParty
  # State state
  # LocalDateTime votingEndTime
  # Map<User, Integer> userBets
  + {abstract} vote(User, Object, int) : String
  + {abstract} resolve(Object) : String
  + cancel() : String
  + endVoting() : String
  + getTotalPot() : int
  + getType() : BetType
}

class DiscreteChoiceBet {
  - List<String> choices
  - Map<User, String> userChoices
  - String correctChoice
  + vote(User, Object, int) : String
  + resolve(Object) : String
  + getVoteDistribution() : Map<String, Integer>
}

class NumericValueBet {
  - Map<User, Double> userValues
  - Double correctValue
  - boolean isInteger
  - Double minValue
  - Double maxValue
  + vote(User, Object, int) : String
  + resolve(Object) : String
  - resolveByProximity(double, int) : String
}

class OrderedRankingBet {
  - List<String> items
  - Map<User, List<String>> userRankings
  - List<String> correctRanking
  + vote(User, Object, int) : String
  + resolve(Object) : String
  - resolveByKendallDistance(int) : String
  - calculateKendallTauDistance(List, List) : double
}

Bet <|-- DiscreteChoiceBet
Bet <|-- NumericValueBet
Bet <|-- OrderedRankingBet
Bet o-- User
Bet o-- WatchParty

class Match {
  - String id
  - String team1
  - String team2
  - LocalDateTime scheduledTime
  - String tournament
  - String stream
  - String bestOf
  + isPast()
  + isFinished()
}
class MatchState <<enum>>
class WatchPartyStatus <<enum>>
class AutoType <<enum>>

class AutoConfig {
  - AutoType type
  - String target
  - Match currentMatch
  + isTeamBased()
  + isTournamentBased()
}

class WatchParty {
  - String name
  - WatchPartyStatus status
  - MatchState matchState
  - AutoConfig autoConfig
  - List<User> participants
  - Bet activeBet
  + updateStatus(Match)
  + canLaunchMiniGame()
  + createBet(Bet) : String
  + hasActiveBet() : boolean
  + getActiveBet() : Bet
}
WatchParty o-- AutoConfig
WatchParty o-- Match
WatchParty o-- User
WatchParty o-- Bet

' Services
class UserService {
  - Map<String, User> users
  + getUser(String)
}
class ChatService {
  - Map<String, Chat> chats
  + createPublicChat(String, User)
  + createPrivateChat(String, User)
}
class BetService {
  - WatchPartyManager watchPartyManager
  - UserService userService
  + createDiscreteChoiceBet(...) : String
  + createNumericValueBet(...) : String
  + createOrderedRankingBet(...) : String
  + vote(...) : String
  + endVoting(...) : String
  + resolveBet(...) : String
  + cancelBet(...) : String
  + getAllActiveBets() : List<Bet>
}
class RankingService {
  + getRanking()
}
class QuizService {
  + answer(...)
}
class LeaguepediaClient {
  - String apiEndpoint
  - HttpClient http
  - Gson gson
  + fetchUpcomingMatchesForTeam(String)
  + fetchUpcomingMatchesForTournament(String)
}
class AutoWatchPartyScheduler {
  - WatchPartyManager manager
  - LeaguepediaClient apiClient
  + updateAllAutoWatchParties()
}
class WatchPartyManager {
  - List<WatchParty> watchParties
  - List<WatchParty> watchPartiesPlanned
  - AutoWatchPartyScheduler scheduler
  + addWatchParty(WatchParty)
  + planifyWatchParty(WatchParty)
  + changeMatchState(...)
}
WatchPartyManager o-- WatchParty
WatchPartyManager o-- AutoWatchPartyScheduler
AutoWatchPartyScheduler o-- LeaguepediaClient

' Controllers -> Services
class BetController
class ChatController
class QuizController
class RankingController
class UserController
class WatchPartyController

BetController --> BetService
BetController --> UserService
ChatController --> ChatService
QuizController --> QuizService
RankingController --> RankingService
UserController --> UserService
WatchPartyController --> WatchPartyManager

' Domain links
BetService o-- Bet
BetService o-- WatchPartyManager
BetService o-- UserService
ChatService o-- UserService
QuizService o-- QuizGame
RankingService o-- UserService
WatchPartyManager o-- LeaguepediaClient

@enduml
