@startuml
left to right direction
skinparam classAttributeIconSize 0

class User {
  - String name
  - boolean admin
  - boolean moderator
  - int publicPoints
  - Map<String, Integer> pointsByWatchParty
  - int publicWins
  - Map<String, Integer> winsByWatchParty
  + addPublicPoints(int)
  + addPointsForWatchParty(String, int)
  + addPublicWin()
  + addWinForWatchParty(String)
}

class Message {
  - User sender
  - String content
  - String timestamp
}

class Chat {
  - String name
  - List<Message> messages
  - User admin
  - MiniGame activeGame
  - List<MiniGame> availableGames
  + sendMessage(User, String)
  + launchGame(User, String)
  + processGameInput(User, String)
  + registerGame(MiniGame)
  + getActiveGame()
}
Chat o-- Message
Chat o-- MiniGame

interface MiniGame {
  + getCommandName()
  + start()
  + processInput(User, String)
  + isFinished()
  + getResults()
  + reset()
}
class QuizGame {
  - Map<User, Integer> scores
  - List<QuizQuestion> questions
  - int currentQuestionIndex
  - boolean isActive
}
MiniGame <|.. QuizGame
QuizGame o-- User

enum TicketType {
  DISCRETE_CHOICE
  NUMERIC_VALUE
  ORDERED_RANKING
  IN_OR_OUT
}

class WatchParty {
  - String name
  - LocalDateTime date
  - String game
  - boolean isPublic
  - boolean planned
  - AutoConfig autoConfig
  - WatchPartyStatus status
  - MatchState matchState
  - List<User> participants
  - User creator
  - Chat chat
  - Map<User, EnumSet<TicketType>> userTickets
  - Bet activeBet
  + static createAutoWatchParty(User, String, AutoType)
  + join(User)
  + leave(User)
  + updateStatus(Match)
  + createBet(Bet) : String
  + closeActiveBet() : String
  + grantTicket(User, TicketType)
}
WatchParty o-- AutoConfig
WatchParty o-- Chat
WatchParty o-- User
WatchParty o-- Bet
WatchParty o-- Match
WatchParty o-- TicketType
WatchParty o-- WatchPartyStatus
WatchParty o-- MatchState

class AutoConfig {
  - AutoType type
  - String target
  - Match currentMatch
  - LocalDateTime lastChecked
  + isTeamBased()
  + isTournamentBased()
  + updateLastChecked()
}
AutoConfig o-- AutoType
enum AutoType
enum WatchPartyStatus
enum MatchState

class Match {
  - String team1
  - String team2
  - LocalDateTime scheduledTime
  - String tournament
  - String stream
  - String bestOf
  + isPast()
  + isStartingSoon(int)
  + isFinished()
}

enum BetType
class Bet {
  # String question
  # User creator
  # WatchParty watchParty
  # State state
  # LocalDateTime votingEndTime
  # Map<User, Integer> userBets
  # boolean offersTicket
  + {abstract} vote(User, Object, int) : String
  + {abstract} resolve(Object) : String
  + cancel() : String
  + endVoting() : String
  + adjustBetPoints(User, int) : String
  + getTotalPot() : int
  + recordWin(User)
  + getType() : BetType
}
class DiscreteChoiceBet {
  - List<String> choices
  - Map<User, String> userChoices
  - String correctChoice
  + getVoteDistribution() : Map<String, Integer>
  + modifyChoice(User, String) : String
}
class NumericValueBet {
  - Map<User, Double> userValues
  - Double correctValue
  - boolean isInteger
  - Double minValue
  - Double maxValue
  + modifyValue(User, Double) : String
}
class OrderedRankingBet {
  - List<String> items
  - Map<User, List<String>> userRankings
  - List<String> correctRanking
  + modifyRanking(User, List<String>) : String
}
Bet <|-- DiscreteChoiceBet
Bet <|-- NumericValueBet
Bet <|-- OrderedRankingBet
Bet o-- WatchParty
Bet o-- User
Bet o-- BetType

class UserService {
  - Map<String, User> users
  + getUser(String)
  + getAllUsers()
}
class ChatService {
  - Chat publicChat
  - UserService userService
  + addMessage(String, String)
  + getMessages()
}
class WatchPartyManager {
  - List<WatchParty> watchParties
  - List<WatchParty> watchPartiesPlanned
  - AutoWatchPartyScheduler scheduler
  + addWatchParty(WatchParty)
  + addAutoWatchParty(WatchParty)
  + getWatchPartyByName(String)
  + getAllWatchParties()
  + startScheduler()
  + forceSchedulerUpdateReport() : String
  + changeMatchState(WatchParty, MatchState, boolean)
}
class AutoWatchPartyScheduler {
  - WatchPartyManager manager
  - LeaguepediaClient apiClient
  - ScheduledExecutorService scheduler
  + start()
  + stop()
  + forceUpdateReport() : String
  + isRunning()
}
class LeaguepediaClient {
  - String apiEndpoint
  - HttpClient http
  - Gson gson
  + getNextTeamMatch(String)
  + getNextTournamentMatch(String)
  + fetchUpcomingMatchesForTeam(String)
  + fetchUpcomingMatchesForTournament(String)
  + updateMatchStatus(Match)
}
class BetService {
  - WatchPartyManager watchPartyManager
  - UserService userService
  + createDiscreteChoiceBet(...)
  + createNumericValueBet(...)
  + createOrderedRankingBet(...)
  + vote(...)
  + endVoting(...)
  + resolveBet(...)
  + cancelBet(...)
  + getAllActiveBets()
}
class RankingService {
  - CachedRanking globalPublicPoints
  - CachedRanking globalPublicWins
  - Map<String, CachedRanking> watchPartyPoints
  - Map<String, CachedRanking> watchPartyWins
  + getGlobalPublicPoints(boolean)
  + getGlobalPublicWins(boolean)
  + getWatchPartyPoints(String, boolean)
  + getWatchPartyWins(String, boolean)
  + refreshAll()
  + refreshWatchParty(String)
}
class RewardService {
  - Map<String, Set<Integer>> awardedThresholds
  + getThresholds()
  + evaluateThresholdRewards()
  + computeMonthlyTop3()
  + runDailyJob()
}
class RewardScheduler {
  - RewardService rewardService
  - ScheduledExecutorService scheduler
  + start()
  + stop()
}
RewardScheduler o-- RewardService

' Controllers -> Services
class BetController
class ChatController
class QuizController
class RankingController
class RewardController
class UserController
class WatchPartyController

BetController --> BetService
ChatController --> ChatService
QuizController --> QuizService
QuizController --> UserService
RankingController --> RankingService
RewardController --> RewardService
UserController --> UserService
WatchPartyController --> WatchPartyManager

' Domain links
WatchPartyManager o-- WatchParty
WatchPartyManager o-- AutoWatchPartyScheduler
AutoWatchPartyScheduler o-- LeaguepediaClient
BetService o-- WatchPartyManager
BetService o-- UserService
RankingService o-- UserService
RankingService o-- WatchPartyManager
RewardService o-- UserService
RewardService o-- RankingService
ChatService o-- Chat
ChatService o-- UserService
QuizService o-- QuizGame

@enduml
