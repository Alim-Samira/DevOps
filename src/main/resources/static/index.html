<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>alll - Plateforme E-sport</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 h-screen flex flex-col font-sans text-gray-900">

    <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold text-blue-600 tracking-tighter">/alll</h1>
            <div id="wp-selector-container">
                <select id="wp-selector" onchange="switchWatchParty(this.value)" class="bg-gray-50 border border-gray-300 text-sm rounded-lg p-2 outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Choisir une WatchParty --</option>
                </select>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="createParty('private')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg text-sm font-semibold transition">
                + Room Priv√©e (User)
            </button>
            <button onclick="createParty('public')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition shadow-md">
                + Room Publique (Admin)
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <main class="flex-1 p-6 overflow-y-auto space-y-6">
            <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="current-wp-title" class="text-xl font-bold text-gray-800">S√©lectionnez une WatchParty</h2>
                    <span id="match-badge" class="hidden px-3 py-1 bg-red-100 text-red-600 text-xs font-bold rounded-full animate-pulse">LIVE</span>
                </div>
                <div id="video-placeholder" class="aspect-video bg-slate-900 rounded-lg flex items-center justify-center text-gray-500 border-4 border-gray-50 italic">
                    Aucun flux actif
                </div>
            </section>

            <section id="betting-section" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4">Pari de la session</h3>
                <div id="bet-content" class="text-gray-400 italic">
                    S√©lectionnez une room pour voir les paris.
                </div>
            </section>
        </main>

        <aside class="w-96 bg-white border-l border-gray-200 flex flex-col shadow-xl">
            <div class="p-4 border-b border-gray-100 bg-gray-50">
                <h3 class="font-bold text-gray-700 flex justify-between">
                    Chat de la Room <span id="user-points" class="text-blue-600">-- pts</span>
                </h3>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3">
                </div>
            <div class="p-4 border-t border-gray-100">
                <form id="chat-form" class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="Parler √† la room..." class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition">Go</button>
                </form>
            </div>
        </aside>
    </div>

    <script>
        const API = "http://localhost:8080/api";
        let activeWP = null;
        let currentUser = "Joueur_" + Math.floor(Math.random() * 100);

        // 1. CHARGER TOUTES LES WATCHPARTIES [cite: 51]
        async function loadAllParties() {
            try {
                const res = await fetch(`${API}/watchparties`);
                const parties = await res.json();
                const selector = document.getElementById('wp-selector');
                
                // On garde l'option par d√©faut
                selector.innerHTML = '<option value="">-- Choisir une WatchParty --</option>';
                parties.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.name;
                    opt.innerText = `${p.public ? 'üåç' : 'üîí'} ${p.name}`;
                    selector.appendChild(opt);
                });
            } catch (err) { console.error("Erreur chargement WP:", err); }
        }

        // 2. CHANGER DE ROOM [cite: 20, 25]
        async function switchWatchParty(name) {
            if (!name) return;
            activeWP = name;
            document.getElementById('current-wp-title').innerText = name;
            document.getElementById('match-badge').classList.remove('hidden');
            refreshWPData();
        }

        // 3. ACTUALISER LES DONN√âES DE LA ROOM (Chat + Paris) [cite: 20, 32]
        async function refreshWPData() {
            if (!activeWP) return;
            try {
                const res = await fetch(`${API}/watchparties/${activeWP}`);
                const wp = await res.json();

                // Update Chat [cite: 25]
                const chatBox = document.getElementById('chat-messages');
                chatBox.innerHTML = wp.chat.messages.map(m => `
                    <div class="text-sm">
                        <span class="font-bold text-blue-600">${m.sender?.name || 'User'}:</span>
                        <span class="text-gray-700">${m.content}</span>
                    </div>
                `).join('');
                chatBox.scrollTop = chatBox.scrollHeight;

                // Update Bet [cite: 32]
                const betBox = document.getElementById('bet-content');
                if (wp.activeBet) {
                    betBox.innerHTML = `
                        <p class="text-lg font-bold text-gray-800 mb-4">${wp.activeBet.question}</p>
                        <div class="flex gap-2">
                            <button onclick="vote('TRUE')" class="flex-1 bg-green-50 text-green-700 border border-green-200 py-2 rounded-lg font-bold hover:bg-green-100">OUI</button>
                            <button onclick="vote('FALSE')" class="flex-1 bg-red-50 text-red-700 border border-red-200 py-2 rounded-lg font-bold hover:bg-red-100">NON</button>
                        </div>
                    `;
                } else {
                    betBox.innerHTML = "Aucun pari actif dans cette room.";
                }
            } catch (err) { console.error("Erreur refresh:", err); }
        }

        // 4. CR√âER UNE WATCHPARTY (User ou Admin)
        async function createParty(type) {
            const name = prompt(`Nom de la nouvelle WatchParty ${type} :`);
            if (!name) return;

            const endpoint = type === 'public' ? '/watchparties/public' : '/watchparties/private';
            try {
                await fetch(`${API}${endpoint}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name: name })
                });
                loadAllParties(); // On rafra√Æchit la liste
                alert(`Room ${name} cr√©√©e !`);
            } catch (err) { alert("Erreur lors de la cr√©ation."); }
        }

        // 5. VOTER
        async function vote(val) {
            await fetch(`${API}/watchparties/${activeWP}/bets/vote`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user: currentUser, value: val, points: 50 })
            });
            alert("Vote enregistr√© !");
        }

        // 6. ENVOYER MESSAGE [cite: 29]
        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            if (!input.value || !activeWP) return;

            await fetch(`${API}/chat`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user: currentUser, text: input.value })
            });
            input.value = '';
            refreshWPData();
        };

        // Boucle de rafra√Æchissement
        loadAllParties();
        setInterval(refreshWPData, 3000);
    </script>
</body>
</html>